(function(a){a.kladr={};a.kladr.url="http://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,e){var b={};if(c.token){b.token=c.token}if(c.key){b.key=c.key}if(c.type){b.contentType=c.type}if(c.name){b.query=c.name}if(c.parentType&&c.parentId){b[c.parentType+"Id"]=c.parentId}if(c.withParents){b.withParent=1}b.limit=c.limit?c.limit:2000;var d=false;a.getJSON(a.kladr.url+"?callback=?",b,function(f){if(d){return}d=true;e&&e(f.result)});setTimeout(function(){if(d){return}d=true;console.error("Request error");e&&e([])},5000)};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(b,a){b.fn.kladr=function(j,o){var w=this;var r=null;var i=null;var u=null;var e={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(C,D){var B={token:u.token,key:u.token,type:u.type,name:C,parentType:u.parentType,parentId:u.parentId,withParents:u.withParents,limit:u.limit};b.kladr.api(B,D)},labelFormat:function(E,C){var B="";var F=E.name.toLowerCase();C=C.toLowerCase();var D=F.indexOf(C);D=D>0?D:0;if(E.typeShort){B+=E.typeShort+". "}if(C.length<E.name.length){B+=E.name.substr(0,D);B+="<strong>"+E.name.substr(D,C.length)+"</strong>";B+=E.name.substr(D+C.length,E.name.length-C.length-D)}else{B+="<strong>"+E.name+"</strong>"}return B},valueFormat:function(C,B){return C.name}};var x={up:38,down:40,esc:27,enter:13};var n=null;var m=function(C,D,E){u=w.data("kladr-options");if(D!==a){u[C]=D;w.data("kladr-options",u);return w}if(b.type(C)==="string"){if(!u){return null}return u[C]}if(u){return w}u=e;if(b.type(C)==="object"){for(var B in C){u[B]=C[B]}}w.data("kladr-options",u);E&&E();return w};var v=function(E){var F="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var C="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var H="";var D;var G;for(var B=0;B<E.length;B++){D=E[B];G=F.indexOf(D);if(G>-1){H+=C[G];continue}H+=D}return H};var q=function(B,C){if(!B){return}w.trigger("kladr_"+B,C);u[B]&&u[B](C)};var d=function(){var C=b(document.getElementById("kladr_autocomplete"));var B=w.attr("name");if(!C.length){C=b('<div id="kladr_autocomplete"></div>').appendTo("body")}w.attr("autocomplete","off");r=b('<ul class="kladr_autocomplete_'+B+'" style="display: none;"></ul>');r.appendTo(C);i=b('<div class="spinner kladr_autocomplete_'+B+'_spinner" class="spinner" style="display: none;"></div>');i.appendTo(C)};var y=function(){var B=w.offset();var D=w.outerWidth();var C=w.outerHeight();r.css({top:B.top+C+"px",left:B.left});var G=r.outerWidth()-r.width();r.width(D-G);var E=i.width();var F=i.height();i.css({top:B.top+(C-F)/2-1,left:B.left+D-E-2,})};var g=function(F,H){r.empty();for(var C in F){var I=F[C];var B=u.valueFormat(I,H);var D=u.labelFormat(I,H);var E=b('<a data-val="'+B+'">'+D+"</a>");E.data("kladr-object",I);var G=b("<li></li>").append(E);G.appendTo(r)}};var t=function(){switch(u.type){case b.kladr.type.region:case b.kladr.type.district:case b.kladr.type.city:break;case b.kladr.type.street:if(u.parentType!=b.kladr.type.city){console.error('For street parentType must equal "city"');return false}if(!u.parentId){console.error("For street parentId must defined");return false}break;case b.kladr.type.building:if(u.parentType!=b.kladr.type.street){console.error('For building parentType must equal "street"');return false}if(!u.parentId){console.error("For building parentId must defined");return false}break;default:console.error('type must defined and equal "region", "district", "city", "street" or "building"');return false}if(u.limit<1){console.error("limit must greater than 0");return false}return true};var h=function(){var B=r.find(".active a");if(!B.length){return}w.val(B.attr("data-val"));u.current=B.data("kladr-object");w.data("kladr-options",u);q("select",u.current)};var s=function(){var B=b(this);if(B.is("li")){B=B.find("a")}h(B);z();w.focus();return false};var c=function(B){var C=r.find("li.active");switch(B.which){case x.up:if(C.length){C.removeClass("active");C=C.prev()}else{C=r.find("li").last()}C.addClass("active");h();break;case x.down:if(C.length){C.removeClass("active");C=C.next()}else{C=r.find("li").first()}C.addClass("active");h();break;case x.esc:z();break;case x.enter:z();return false}};var f=function(){if(!u.verify){return}if(!t()){return}var B=v(w.val());if(!b.trim(B)){return}A();q("send");u.source(B,function(E){l();q("received");var F=null;for(var D=0;D<E.length;D++){var C=B.toLowerCase();var G=E[D].name.toLowerCase();if(C==G){F=E[D];break}}if(F){w.val(u.valueFormat(F,B))}u.current=F;w.data("kladr-options",u);q("check",u.current)})};var p=function(C){if((C.which>8)&&(C.which<46)){return}if(!t()){return}var B=v(w.val());if(!b.trim(B)){z();return}A();q("send");u.source(B,function(D){l();q("received");if(!w.is(":focus")){z();return}if(!b.trim(w.val())||!D.length){z();return}g(D,B);y();r.slideDown(50);q("open")})};var z=function(){h();r.hide();q("close")};var k=function(){if(n){return}var B=-0.2;n=setInterval(function(){if(!i.is(":visible")){clearInterval(n);n=null;return}i.css("background-position","0% "+B+"%");B+=5.555556;if(B>95){B=-0.2}},30)};var A=function(){if(u.showSpinner){i.show();k()}};var l=function(){i.hide()};return m(j,o,function(){var B=false;d();y();w.keyup(p);w.keydown(c);w.change(f);w.blur(function(){if(!B){z()}});r.on("click","li, a",s);r.on("mouseenter","li",function(){b(this).addClass("active");B=true});r.on("mouseleave","li",function(){b(this).removeClass("active");B=false});b(window).resize(y)})}})(jQuery);